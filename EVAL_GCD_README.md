# åŸç‰ˆGCDæ¨¡å‹è¯„ä¼°å·¥å…·

ä½¿ç”¨`eval_pretrained_gcd.py`è„šæœ¬è¯„ä¼°åŸç‰ˆGCDè®­ç»ƒå¾—åˆ°çš„é¢„è®­ç»ƒæ¨¡å‹ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹ç‚¹

- âœ… **å®Œå…¨å…¼å®¹**ï¼šä¸åŸç‰ˆGCDè®­ç»ƒæ—¶çš„è¯„ä¼°æ–¹æ³•100%ä¸€è‡´
- âœ… **æ•°æ®é›†ä¸€è‡´**ï¼šä½¿ç”¨å®Œæ•´æµ‹è¯•é›†ï¼ŒåŒ…å«æ‰€æœ‰å·²çŸ¥+æœªçŸ¥ç±»åˆ«
- âœ… **ACCè®¡ç®—ä¸€è‡´**ï¼šä½¿ç”¨ç›¸åŒçš„cluster_acc + Hungarianç®—æ³•
- âœ… **ç±»åˆ«åˆ’åˆ†ä¸€è‡´**ï¼šCIFAR-100æ ‡å‡†åˆ’åˆ† (80å·²çŸ¥ + 20æœªçŸ¥)
- âœ… **å¤šç§è¯„ä¼°æ¨¡å¼**ï¼šæ”¯æŒå…¨æ•°æ®é›†ã€å•è¶…ç±»ã€æ‰¹é‡è¶…ç±»è¯„ä¼°

## ğŸ“‹ ç¡®ä¿ä¸€è‡´æ€§çš„å…³é”®è¦ç´ 

### 1. **æ•°æ®é›†é…ç½®**
```python
# ä¸åŸç‰ˆGCDå®Œå…¨ç›¸åŒçš„è®¾ç½®
args.dataset_name = 'cifar100'
args.train_classes = range(80)      # å·²çŸ¥ç±»: 0-79
args.unlabeled_classes = range(80, 100)  # æœªçŸ¥ç±»: 80-99
args.test_classes = range(100)      # æµ‹è¯•é›†åŒ…å«æ‰€æœ‰ç±»åˆ«
```

### 2. **ACCè®¡ç®—æ–¹æ³•**
```python
# ä½¿ç”¨åŸç‰ˆçš„log_accs_from_predså‡½æ•°
all_acc, old_acc, new_acc = log_accs_from_preds(
    y_true=targets,     # çœŸå®æ ‡ç­¾
    y_pred=preds,       # K-meansèšç±»ç»“æœ
    mask=mask,          # å·²çŸ¥ç±»mask (åŸºäºtrain_classes)
    eval_funcs=['v1']   # ä½¿ç”¨split_cluster_acc_v1
)
```

### 3. **èšç±»é…ç½®**
```python
# K-meansèšç±»æ•° = å·²çŸ¥ç±»æ•° + æœªçŸ¥ç±»æ•°
n_clusters = 80 + 20 = 100
kmeans = KMeans(n_clusters=100, random_state=0, n_init=10)
```

### 4. **Maskå®šä¹‰**
```python
# mask[i] = True å½“ä¸”ä»…å½“ label[i] åœ¨ train_classes ä¸­
mask = np.array([True if x.item() in range(len(args.train_classes))
                 else False for x in label])
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### **1. å®Œæ•´CIFAR-100æ•°æ®é›†è¯„ä¼°**
```bash
python eval_pretrained_gcd.py \
    --model_path /path/to/model_best.pt \
    --proj_head_path /path/to/model_proj_head_best.pt \
    --eval_mode full
```

### **2. å•ä¸ªè¶…ç±»è¯„ä¼°**
```bash
python eval_pretrained_gcd.py \
    --model_path /path/to/model_best.pt \
    --proj_head_path /path/to/model_proj_head_best.pt \
    --eval_mode superclass \
    --superclass_name trees
```

### **3. æ‰€æœ‰è¶…ç±»æ‰¹é‡è¯„ä¼°**
```bash
python eval_pretrained_gcd.py \
    --model_path /path/to/model_best.pt \
    --proj_head_path /path/to/model_proj_head_best.pt \
    --eval_mode all_superclasses
```

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

### **å®Œæ•´æ•°æ®é›†è¯„ä¼°**
```
ğŸŒ å®Œæ•´CIFAR-100æ•°æ®é›†è¯„ä¼°
================================================================================
ğŸ“Š å·²çŸ¥ç±»åˆ«: [0, 1, 2, ..., 79] (å…±80ä¸ª)
ğŸ“Š æœªçŸ¥ç±»åˆ«: [80, 81, 82, ..., 99] (å…±20ä¸ª)
ğŸ“Š æµ‹è¯•ç±»åˆ«: 100ä¸ªç±»åˆ« (æ‰€æœ‰å·²çŸ¥+æœªçŸ¥ç±»åˆ«)
ğŸ“Š åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼° (å…±100ä¸ªç±»)...
ğŸ“Š ä½¿ç”¨è¯„ä¼°å‡½æ•°: ['v1']
ğŸ“Š K-meansèšç±»æ•°: 100

ğŸ“ˆ å®Œæ•´æ•°æ®é›†è¯„ä¼°ç»“æœ:
   All ACC: 0.7823
   Old ACC: 0.8456
   New ACC: 0.6789
```

### **è¶…ç±»è¯„ä¼°**
```
ğŸ¯ è¶…ç±» 'trees' è¯„ä¼°
================================================================================
ğŸ“Š å·²çŸ¥ç±»åˆ«: [0, 1, 2, ..., 79] (å…±80ä¸ª)
ğŸ“Š æœªçŸ¥ç±»åˆ«: [80, 81, 82, ..., 99] (å…±20ä¸ª)
ğŸ“Š è¶…ç±»åŒ…å«ç±»åˆ«: [47, 52, 56, 59, 96]
ğŸ“Š åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°...

ğŸ¯ å¼€å§‹è¶…ç±» "trees" è¯„ä¼°...
   è¶…ç±»åŒ…å«ç±»åˆ«: [47, 52, 56, 59, 96]
   è¿‡æ»¤åæ ·æœ¬æ•°: 5000
   å®é™…ç±»åˆ«æ•°: 5
   å·²çŸ¥ç±»åˆ«æ•°: 4
   æœªçŸ¥ç±»åˆ«æ•°: 1

ğŸ“Š è¶…ç±» 'trees' è¯„ä¼°ç»“æœ (åŒ…å«æœªçŸ¥ç±»):
   All ACC: 0.8150
   Old ACC: 0.8900
   New ACC: 0.6200
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### **1. æ¨¡å‹æ–‡ä»¶è¦æ±‚**
- **ä¸»æ¨¡å‹æ–‡ä»¶**ï¼š`model.pt` æˆ– `model_best.pt`
- **æŠ•å½±å¤´æ–‡ä»¶**ï¼š`model_proj_head.pt` æˆ– `model_proj_head_best.pt`
- ä¸¤ä¸ªæ–‡ä»¶å¿…é¡»æ¥è‡ªåŒä¸€æ¬¡è®­ç»ƒ

### **2. å‚æ•°é…ç½®**
ç¡®ä¿è¯„ä¼°æ—¶çš„æ¨¡å‹é…ç½®ä¸è®­ç»ƒæ—¶å®Œå…¨ä¸€è‡´ï¼š
```bash
--feat_dim 768          # ViT-Baseç‰¹å¾ç»´åº¦
--mlp_out_dim 65536     # æŠ•å½±å¤´è¾“å‡ºç»´åº¦
--num_mlp_layers 3      # æŠ•å½±å¤´å±‚æ•°
--base_model vit_dino   # åŸºç¡€æ¨¡å‹ç±»å‹
```

### **3. ç¯å¢ƒè¦æ±‚**
- PyTorch ç¯å¢ƒ
- ä¸è®­ç»ƒæ—¶ç›¸åŒçš„æ•°æ®é›†é…ç½®
- æ­£ç¡®çš„DINOé¢„è®­ç»ƒæƒé‡è·¯å¾„

## ğŸ“ˆ ç»“æœè§£é‡Š

### **ACCæŒ‡æ ‡å«ä¹‰**
- **All ACC**: æ•´ä½“èšç±»å‡†ç¡®ç‡ (åŠ æƒå¹³å‡)
- **Old ACC**: å·²çŸ¥ç±»èšç±»å‡†ç¡®ç‡
- **New ACC**: æœªçŸ¥ç±»èšç±»å‡†ç¡®ç‡

### **è®¡ç®—å…¬å¼**
```python
# split_cluster_acc_v1æ–¹æ³•
weight = mask.mean()  # å·²çŸ¥ç±»æ ·æœ¬æ¯”ä¾‹
total_acc = weight * old_acc + (1 - weight) * new_acc
```

### **è¶…ç±»è¯„ä¼°ç‰¹ç‚¹**
- è¶…ç±»è¯„ä¼°åªåœ¨è¯¥è¶…ç±»å†…éƒ¨è¿›è¡Œèšç±»
- æ ‡ç­¾é‡æ–°æ˜ å°„åˆ°è¿ç»­çš„0-nèŒƒå›´
- ä¿æŒå·²çŸ¥/æœªçŸ¥ç±»çš„ç›¸å¯¹æ¯”ä¾‹

è¿™ä¸ªå·¥å…·ç¡®ä¿äº†è¯„ä¼°ç»“æœä¸åŸç‰ˆGCDè®­ç»ƒæ—¶çš„æµ‹è¯•ç»“æœå®Œå…¨ä¸€è‡´ï¼